<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ­æ´²äº¤æ›_2024/08~2025/02</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; background-color: #fff; font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100vw; }
        
        /* æ¨™ç±¤æ¨£å¼ */
        .custom-label-container { display: flex; flex-direction: column; align-items: center; transform: translateY(-15px); }
        .custom-label { background: #fff; color: #333; border-radius: 8px; padding: 4px 10px; font-weight: 900; font-size: 15px; box-shadow: 0 3px 8px rgba(0,0,0,0.3); white-space: nowrap; border: 2px solid #333; }
        .vehicle-icon { font-size: 45px; line-height: 45px; text-align: center; filter: drop-shadow(0 3px 5px rgba(0,0,0,0.4)); z-index: 1000 !important; transition: none; }
        
        /* --- ç…§ç‰‡æ¡†æ¨£å¼ (å„ªåŒ–ç‰ˆ) --- */
        #photo-frame { 
            position: fixed; 
            bottom: 30px; 
            right: 30px; 
            width: 250px; 
            background: #fff; 
            padding: 12px 12px 45px 12px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.5); /* é™°å½±åŠ æ·±ä¸€é»æ›´æœ‰ç«‹é«”æ„Ÿ */
            transform: rotate(-5deg) translateY(400px); /* è—å¾—æ›´æ·±ä¸€é»ç¢ºä¿å®Œå…¨ç§»å‡º */
            /* ä½¿ç”¨ opacity å’Œ transform é€²è¡Œéæ¸¡ï¼ŒåŠ å…¥ will-change æå‡æ•ˆèƒ½ */
            transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.6s ease-in-out, width 0.4s ease; 
            z-index: 3000; 
            opacity: 0; 
            border-radius: 2px; 
            pointer-events: none; /* é¿å…éš±è—æ™‚æ“‹åˆ°åœ°åœ–æ“ä½œ */
            will-change: transform, opacity; /* å‘Šè¨´ç€è¦½å™¨é€™æœƒå‹•ï¼Œè«‹é–‹åŠ é€Ÿ */
        }

        /* æ©«å¼ç…§ç‰‡å°ˆç”¨æ¨£å¼ */
        #photo-frame.landscape {
            width: 450px; 
            right: 20px;  
            transform: rotate(3deg) translateY(400px); 
        }

        /* é¡¯ç¤ºç‹€æ…‹ */
        #photo-frame.show { 
            transform: rotate(-3deg) translateY(0); 
            opacity: 1; 
            pointer-events: auto;
        }
        /* æ©«å¼é¡¯ç¤ºç‹€æ…‹ */
        #photo-frame.landscape.show {
            transform: rotate(2deg) translateY(0);
            opacity: 1;
        }

        #photo-img { width: 100%; height: auto; display: block; border: 1px solid #eee; min-height: 150px; background: #f0f0f0; }
        #photo-caption { font-family: 'Segoe Print', 'Chalkboard SE', sans-serif; color: #444; margin-top: 15px; text-align: center; font-weight: bold; font-size: 1.2rem; }

        /* æ§åˆ¶é¢æ¿ */
        #controls { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; text-align: center; width: 90%; pointer-events: none; }
        #controls > * { pointer-events: auto; }
        #status-bar { background: rgba(0, 0, 0, 0.85); color: #fff; padding: 10px 25px; border-radius: 50px; font-weight: bold; font-size: 1.1rem; margin-bottom: 15px; display: inline-block; border: 2px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.5); transition: all 0.3s; }        button { background: #e63946; color: white; border: none; padding: 12px 30px; border-radius: 50px; font-size: 18px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 0 #a01a23; transition: transform 0.1s; margin: 5px; }
        button:hover { background: #ff4d5a; }
        button:active { transform: translateY(4px); box-shadow: none; }        /* éŸ³æ¨‚æ§åˆ¶æŒ‰éˆ• */
        #music-control { position: fixed; bottom: 20px; left: 20px; z-index: 2000; background: rgba(0,0,0,0.7); color: white; border: none; padding: 10px 15px; border-radius: 50%; font-size: 20px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        #music-control:hover { background: rgba(0,0,0,0.9); }
        
        /* æš«åœæ§åˆ¶æŒ‰éˆ• */
        #pause-control { position: fixed; bottom: 80px; left: 20px; z-index: 2000; background: rgba(0,0,0,0.7); color: white; border: none; padding: 10px 15px; border-radius: 50%; font-size: 20px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: none; }
        #pause-control:hover { background: rgba(0,0,0,0.9); }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div id="photo-frame">
        <img id="photo-img" src="" alt="Travel Photo">
        <div id="photo-caption">My Memory</div>
    </div>    <div id="controls">
        <div id="status-bar">æº–å‚™å•Ÿç¨‹ âœˆï¸</div><br>
        <button onclick="startJourney()">æ’­æ”¾!</button>
    </div>    <!-- éŸ³æ¨‚æ§åˆ¶æŒ‰éˆ• -->
    <button id="music-control" onclick="toggleMusic()" title="éŸ³æ¨‚é–‹é—œ">ğŸµ</button>

    <!-- æš«åœæ§åˆ¶æŒ‰éˆ• -->
    <button id="pause-control" onclick="togglePause()" title="æš«åœ/ç¹¼çºŒ">â¸ï¸</button>

    <!-- èƒŒæ™¯éŸ³æ¨‚ -->
    <audio id="background-music" loop preload="auto">
        <source src="music/background-music.mp3" type="audio/mpeg">
        <source src="music/background-music.ogg" type="audio/ogg">
        æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´éŸ³æ¨‚æ’­æ”¾
    </audio>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        var map = L.map('map', { zoomControl: false, attributionControl: false, zoomSnap: 0.1 }).setView([25.0797, 121.2342], 5);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);

        // ä½ çš„å®Œæ•´è³‡æ–™
        const route = [
            { country: "å°ç£", city: "æ¡ƒåœ’", lat: 25.0797, lng: 121.2342, type: "start", icon: "ğŸš©" },
            { country: "å¾·åœ‹", city: "æ³•è˜­å…‹ç¦", lat: 50.0379, lng: 8.5622, type: "plane", icon: "âœˆï¸" },
            
            { country: "æ¯”åˆ©æ™‚", city: "å¸ƒé­¯å¡çˆ¾", lat: 50.8503, lng: 4.3517, type: "train", icon: "ğŸš†", image: "brussels.jpg" },
            { country: "æ¯”åˆ©æ™‚", city: "æ ¹ç‰¹", lat: 51.0543, lng: 3.7174, type: "train", icon: "ğŸš†", image: "gent.jpg" },
            { country: "æ¯”åˆ©æ™‚", city: "å¸ƒé­¯å¡çˆ¾", lat: 50.8503, lng: 4.3517, type: "train", icon: "ğŸš†" }, 
            { country: "æ¯”åˆ©æ™‚", city: "å¸ƒé­¯æ—¥", lat: 51.2093, lng: 3.2247, type: "train", icon: "ğŸš†", image: "burge.jpg" },
            { country: "æ¯”åˆ©æ™‚", city: "å¸ƒé­¯å¡çˆ¾", lat: 50.8503, lng: 4.3517, type: "train", icon: "ğŸš†" },
            
            { country: "æ³•åœ‹", city: "å·´é»", lat: 48.8566, lng: 2.3522, type: "bus", icon: "ğŸšŒ", image: "paris.jpg" },
            { country: "æ³•åœ‹", city: "è¿ªå£«å°¼", lat: 48.8698, lng: 2.7828, type: "train", icon: "ğŸš‡", image: "disney.jpg" }, 
            { country: "æ³•åœ‹", city: "å·´é»", lat: 48.8566, lng: 2.3522, type: "bus", icon: "ğŸšŒ" , image: "paris2.jpg"},    

            { country: "å¾·åœ‹", city: "æ³•è˜­å…‹ç¦", lat: 50.1109, lng: 8.6821, type: "train", icon: "ğŸš†", image: "frankfort.jpg" }, 
            { country: "å¾·åœ‹", city: "ç§‘éš†", lat: 50.9375, lng: 6.9603, type: "train", icon: "ğŸš†", image: "koln.jpg" },
            { country: "ç›§æ£®å ¡", city: "ç›§æ£®å ¡", lat: 49.6116, lng: 6.1319, type: "bus", icon: "ğŸšŒ", image: "lusenburg.jpg" },
            { country: "å¾·åœ‹", city: "æ³•è˜­å…‹ç¦", lat: 50.1109, lng: 8.6821, type: "train", icon: "ğŸš†" },
            
            { country: "å¾·åœ‹", city: "æ¼¢å ¡", lat: 53.5511, lng: 9.9937, type: "train", icon: "ğŸš†" },
            { country: "æŒªå¨", city: "å¥§æ–¯é™¸", lat: 59.9139, lng: 10.7522, type: "bus", icon: "ğŸšŒ", image: "oslo.jpg" },
            { country: "æŒªå¨", city: "ç‰¹ç¾…å§†ç‘Ÿ", lat: 69.6492, lng: 18.9553, type: "plane", icon: "âœˆï¸", image: "tromso.jpg" },
            { country: "æŒªå¨", city: "å¡å°¼äºå³¶", lat: 69.4000, lng: 17.5000, type: "car", icon: "ğŸš—", image: "senja.jpg" }, 
            { country: "æŒªå¨", city: "ç‰¹ç¾…å§†ç‘Ÿ", lat: 69.6492, lng: 18.9553, type: "car", icon: "ğŸš—", image: "orola.jpg" }, 
            { country: "æŒªå¨", city: "å¥§æ–¯é™¸", lat: 59.9139, lng: 10.7522, type: "plane", icon: "âœˆï¸", image: "oslo2.jpg" },
            { country: "å¾·åœ‹", city: "æŸæ—", lat: 52.5200, lng: 13.4050, type: "plane", icon: "âœˆï¸", image: "berlin.jpg" },
            { country: "å¾·åœ‹", city: "æ³•è˜­å…‹ç¦", lat: 50.1109, lng: 8.6821, type: "train", icon: "ğŸš†" },

            { country: "å¾·åœ‹", city: "æ…•å°¼é»‘", lat: 48.1351, lng: 11.5820, type: "bus", icon: "ğŸšŒ", image: "muchen.jpg"  },
            { country: "å¾·åœ‹", city: "åœ‹ç‹æ¹–", lat: 47.5715, lng: 12.9880, type: "train", icon: "ğŸš†" , image: "kinglake.jpg" },
            { country: "å¾·åœ‹", city: "æ…•å°¼é»‘", lat: 48.1351, lng: 11.5820, type: "train", icon: "ğŸš†" , image: "muchen2.jpg" },

            { country: "å¾·åœ‹", city: "æ³•è˜­å…‹ç¦", lat: 50.1109, lng: 8.6821, type: "train", icon: "ğŸš†" },
            { country: "å¥§åœ°åˆ©", city: "ç¶­ä¹Ÿç´", lat: 48.2082, lng: 16.3738, type: "bus", icon: "ğŸšŒ", image: "wine.jpg" },
            { country: "æ–¯æ´›ä¼å…‹", city: "å¸ƒæ‹‰è¿ªæ–¯æ‹‰ç™¼", lat: 48.1486, lng: 17.1077, type: "bus", icon: "ğŸšŒ" , image: "slovak.jpg"},
            { country: "å¥§åœ°åˆ©", city: "ç¶­ä¹Ÿç´", lat: 48.2082, lng: 16.3738, type: "bus", icon: "ğŸšŒ" , image: "wine2.jpg" },
            { country: "å¥§åœ°åˆ©", city: "å“ˆçˆ¾æ–½å¡”ç‰¹", lat: 47.5622, lng: 13.6493, type: "bus", icon: "ğŸšŒ", image: "hallstadt.jpg"  },
            { country: "å¥§åœ°åˆ©", city: "è–©çˆ¾æ–¯å ¡", lat: 47.8095, lng: 13.0550, type: "bus", icon: "ğŸšŒ", image: "zarsburg.jpg" },
            { country: "å¾·åœ‹", city: "æ…•å°¼é»‘", lat: 48.1351, lng: 11.5820, type: "train", icon: "ğŸš†" },
            { country: "å¾·åœ‹", city: "æ³•è˜­å…‹ç¦", lat: 50.1109, lng: 8.6821, type: "train", icon: "ğŸš†" },
            
            { country: "æ·å…‹", city: "å¸ƒæ‹‰æ ¼", lat: 50.0755, lng: 14.4378, type: "bus", icon: "ğŸšŒ" , image: "jack.jpg"},
            { country: "å¾·åœ‹", city: "æ³•è˜­å…‹ç¦", lat: 50.1109, lng: 8.6821, type: "bus", icon: "ğŸšŒ" },
            { country: "å¾·åœ‹", city: "æŸæ—", lat: 52.5200, lng: 13.4050, type: "train", icon: "ğŸš†" },
            { country: "ä¸¹éº¥", city: "å“¥æœ¬å“ˆæ ¹", lat: 55.6761, lng: 12.5683, type: "bus", icon: "ğŸšŒ" , image: "cobenhegen.jpg"},
            { country: "ç‘å…¸", city: "é¦¬çˆ¾é»˜", lat: 55.6045, lng: 13.0038, type: "train", icon: "ğŸš†" , image: "marmo.jpeg"},
            { country: "ä¸¹éº¥", city: "å“¥æœ¬å“ˆæ ¹", lat: 55.6761, lng: 12.5683, type: "train", icon: "ğŸš†", image: "cobenhegen2.jpg" },
            { country: "å¾·åœ‹", city: "æŸæ—", lat: 52.5200, lng: 13.4050, type: "bus", icon: "ğŸšŒ", image: "berlin2.jpg" },
            { country: "å¾·åœ‹", city: "æ³•è˜­å…‹ç¦", lat: 50.1109, lng: 8.6821, type: "train", icon: "ğŸš†" },

            { country: "å…‹ç¾…åŸƒè¥¿äº", city: "è–©æ ¼å‹’å¸ƒ", lat: 45.8150, lng: 15.9819, type: "plane", icon: "âœˆï¸", image: "croasia.jpg" },
            { country: "å…‹ç¾…åŸƒè¥¿äº", city: "ç¾…ç¶­å°¼", lat: 45.0812, lng: 13.6387, type: "bus", icon: "ğŸšŒ", image: "loveni.jpg"  },
            { country: "å¾·åœ‹", city: "æ³•è˜­å…‹ç¦", lat: 50.1109, lng: 8.6821, type: "train", icon: "ğŸš†" },

            { country: "ç¾©å¤§åˆ©", city: "ç±³è˜­", lat: 45.4642, lng: 9.1900, type: "plane", icon: "âœˆï¸" , image: "milan.jpg"},
            { country: "ç¾©å¤§åˆ©", city: "æ¯”è–©", lat: 43.7228, lng: 10.4017, type: "bus", icon: "ğŸšŒ", image: "piza.jpg" },
            { country: "ç¾©å¤§åˆ©", city: "äº”æ¼æ‘", lat: 44.1115, lng: 9.7330, type: "train", icon: "ğŸš†" , image: "fivefish.jpg"},
            { country: "ç¾©å¤§åˆ©", city: "æ¯”è–©", lat: 43.7228, lng: 10.4017, type: "train", icon: "ğŸš†" },
            { country: "ç¾©å¤§åˆ©", city: "å¨å°¼æ–¯", lat: 45.4408, lng: 12.3155, type: "bus", icon: "ğŸšŒ" , image: "venise.jpg"},
            { country: "å¾·åœ‹", city: "æ³•è˜­å…‹ç¦", lat: 50.1109, lng: 8.6821, type: "bus", icon: "ğŸšŒ" },
            { country: "ç‘å£«", city: "è˜‡é»ä¸–", lat: 47.3769, lng: 8.5417, type: "train", icon: "ğŸš†" , image: "zulish.jpg"},
            { country: "å¥§åœ°åˆ©", city: "å¸ƒé›·æ ¹èŒ¨", lat: 47.5031, lng: 9.7471, type: "bus", icon: "ğŸšŒ", image: "bregenzer.jpg" },
            { country: "å¾·åœ‹", city: "æ…•å°¼é»‘", lat: 48.1351, lng: 11.5820, type: "train", icon: "ğŸš†" },
            { country: "å¾·åœ‹", city: "æ³•è˜­å…‹ç¦", lat: 50.1109, lng: 8.6821, type: "train", icon: "ğŸš†" },

            { country: "è‹±åœ‹", city: "å€«æ•¦", lat: 51.5074, lng: -0.1278, type: "plane", icon: "âœˆï¸" , image: "london.jpg"},
            { country: "è‹±åœ‹", city: "ç‰›æ´¥", lat: 51.7520, lng: -1.2577, type: "train", icon: "ğŸš†" , image: "newgin.jpeg"},
            { country: "è‹±åœ‹", city: "å€«æ•¦", lat: 51.5074, lng: -0.1278, type: "train", icon: "ğŸš†" , image: "london2.jpg"},
            
            { country: "æ³¢è˜­", city: "è¯æ²™", lat: 52.2297, lng: 21.0122, type: "plane", icon: "âœˆï¸" , image: "warsa.jpg" },
            { country: "æ³¢è˜­", city: "å…‹æ‹‰ç§‘å¤«", lat: 50.0647, lng: 19.9450, type: "bus", icon: "ğŸšŒ" , image: "crocof.jpg" }, 
            { country: "åŒˆç‰™åˆ©", city: "å¸ƒé”ä½©æ–¯", lat: 47.4979, lng: 19.0402, type: "bus", icon: "ğŸšŒ" , image: "budapest.jpg"},
            { country: "ç¾…é¦¬å°¼äº", city: "å¸ƒåŠ å‹’æ–¯ç‰¹", lat: 44.4268, lng: 26.1025, type: "train", icon: "ğŸš†", image: "buchalust.jpg" },
            { country: "ç¾…é¦¬å°¼äº", city: "å¸ƒæ‹‰ç´¢å¤«", lat: 45.6427, lng: 25.5902, type: "train", icon: "ğŸš†" , image: "brasov.jpg"},
            { country: "ç¾…é¦¬å°¼äº", city: "å¸ƒåŠ å‹’æ–¯ç‰¹", lat: 44.4268, lng: 26.1025, type: "train", icon: "ğŸš†", image: "buchalust2.jpg" },
            { country: "ä¿åŠ åˆ©äº", city: "ç´¢è²äº", lat: 42.6977, lng: 23.3219, type: "bus", icon: "ğŸšŒ" , image: "sofia.jpg"},
            { country: "å¸Œè‡˜", city: "é›…å…¸", lat: 37.9838, lng: 23.7275, type: "plane", icon: "âœˆï¸", image: "athen.jpg" },
            
            { country: "å¸Œè‡˜", city: "é‚éŒ«å°¼", lat: 37.7308, lng: 22.7561, type: "bus", icon: "ğŸšŒ", image: "mycenae.jpg" },
            { country: "å¸Œè‡˜", city: "é›…å…¸", lat: 37.9838, lng: 23.7275, type: "bus", icon: "ğŸšŒ" , image: "athen2.jpeg"},

            { country: "å¾·åœ‹", city: "æ³•è˜­å…‹ç¦", lat: 50.1109, lng: 8.6821, type: "plane", icon: "âœˆï¸" }
        ];        let vehicleMarker, pathLine, currentPathCoordinates = [], visitedCities = new Set();
        // åœ–ç‰‡å¿«å–
        const imageCache = new Map();
        // æš«åœæ§åˆ¶
        let isPaused = false;
        let pauseResolve = null;

        function preloadImage(url) {
            if (!url || imageCache.has(url)) return;
            const img = new Image();
            img.src = 'images/' + url;
            imageCache.set(url, img);
        }          async function startJourney() {
            document.querySelector('button').style.display = 'none';
            document.getElementById('pause-control').style.display = 'block';
            
            // é–‹å§‹æ’­æ”¾èƒŒæ™¯éŸ³æ¨‚
            const backgroundMusic = document.getElementById('background-music');
            try {
                await backgroundMusic.play();
            } catch (error) {
                console.log('éŸ³æ¨‚æ’­æ”¾å¤±æ•—ï¼Œå¯èƒ½éœ€è¦ç”¨æˆ¶äº’å‹•:', error);
            }
            
            map.eachLayer(l => { if (l instanceof L.Marker || l instanceof L.Polyline) map.removeLayer(l); });
            visitedCities.clear();
            
            // åˆå§‹è¨­ç½®
            addLocationMarker(route[0]); 
            map.setView([route[0].lat, route[0].lng], 6, {animate:false});
            
            vehicleMarker = L.marker([route[0].lat, route[0].lng], {icon: L.divIcon({className:'vehicle-icon', html:route[0].icon, iconSize:[45,45], iconAnchor:[22,22]}), zIndexOffset:3000}).addTo(map);
            currentPathCoordinates = [[route[0].lat, route[0].lng]];
            pathLine = L.polyline(currentPathCoordinates, {color:'#1d3557', weight:4, opacity:0.8, dashArray:'10,10', lineCap:'round'}).addTo(map);

            if(route[0].image) showPhoto(route[0]);

            for (let i=0; i<route.length-1; i++) {
                let s = route[i], e = route[i+1];
                
                // --- å„ªåŒ–é—œéµ 1: åœ¨ç§»å‹•é–‹å§‹å‰ï¼Œå…ˆæ·¡å‡ºä¸Šä¸€å¼µç…§ç‰‡ (é€™æ¨£æ‰ä¸æœƒè·³) ---
                // å¦‚æœä¸‹ä¸€å€‹é»æœ‰ç…§ç‰‡ï¼Œä»£è¡¨æˆ‘å€‘æº–å‚™è¦æ›æ–°çš„ï¼Œé€™è£¡å…ˆéš±è—èˆŠçš„
                // æˆ–è€…å¦‚æœä¸‹ä¸€å€‹é»æ²’ç…§ç‰‡ï¼Œä¹Ÿæ˜¯è¦éš±è—
                hidePhoto(); 

                // --- å„ªåŒ–é—œéµ 2: ç§»å‹•éç¨‹ä¸­é è¼‰ä¸‹ä¸€å¼µåœ– ---
                if (e.image) preloadImage(e.image);

                updateStatus(`${s.city} â” ${e.city}`);
                vehicleMarker.setIcon(L.divIcon({className:'vehicle-icon', html:e.icon, iconSize:[45,45], iconAnchor:[22,22]}));
                
                let dist = getDistance(s.lat, s.lng, e.lat, e.lng);
                let z = 7;
                if (e.type==='plane'||dist>600) z=5; 
                else if(['å€«æ•¦','é›…å…¸','è¯æ²™','å¸ƒåŠ å‹’æ–¯ç‰¹'].includes(e.city)) z=6; 
                else if(dist<100) z=9;
                
                map.setZoom(z, {animate: true});
                await wait(1000); // ç¸®æ”¾æ™‚é–“ï¼Œé€™æ™‚å€™ç…§ç‰‡æ­£åœ¨æ·¡å‡º

                await animateMove(s, e);                if (!visitedCities.has(e.city)) { addLocationMarker(e); visitedCities.add(e.city); } else { addDot(e); }
                
                // --- å„ªåŒ–é—œéµ 3: æŠµé”å¾Œï¼Œå› ç‚ºåœ–ç‰‡å·²ç¶“é è¼‰å¥½äº†ï¼Œæœƒé¦¬ä¸Šé¡¯ç¤º ---
                if (e.image) {
                    showPhoto(e);
                    await wait(2000); // æœ‰ç…§ç‰‡æ™‚åœç•™ä¹…ä¸€é»è®“ç…§ç‰‡è¢«çœ‹æ¸…æ¥š                } else {
                    await wait(1200); // æ²’æœ‰ç…§ç‰‡æ™‚åœç•™æ™‚é–“è¼ƒçŸ­
                }
                // ä¸éœ€è¦ else hidePhoto()ï¼Œå› ç‚ºæˆ‘å€‘åœ¨ loop é–‹é ­å°± hide äº†
            }
            updateStatus("äº¤æ›çµæŸ~"); 
            document.querySelector('button').style.display = 'inline-block';
            document.getElementById('pause-control').style.display = 'none';
        }

        function showPhoto(p) {
            const f = document.getElementById('photo-frame');
            const i = document.getElementById('photo-img');
            const c = document.getElementById('photo-caption');
            
            // å…ˆæŠŠå…§å®¹æ›æ‰ï¼Œé€™æ™‚å€™å› ç‚º opacity é‚„æ˜¯ 0ï¼Œæ‰€ä»¥ä½¿ç”¨è€…çœ‹ä¸åˆ°æ›åœ–çš„ç¬é–“
            i.src = 'images/' + p.image;
            c.innerText = p.city + ", " + p.country;
            
            // ç¢ºä¿ç§»é™¤æ‰€æœ‰èˆŠçš„é¡¯ç¤º class
            f.classList.remove('show', 'landscape');

            i.onload = function() {
                if (this.naturalWidth > this.naturalHeight) {
                    f.classList.add('landscape');
                }
                // å¼·åˆ¶é‡ç¹ª (Reflow) ç¢ºä¿éæ¸¡å‹•ç•«æ­£å¸¸è§¸ç™¼
                void f.offsetWidth; 
                f.classList.add('show');
            };
            
            // å¦‚æœåœ–ç‰‡å·²ç¶“åœ¨ cache (å› ç‚º preload)ï¼Œonload æœƒæ¥µå¿«è§¸ç™¼
            if (i.complete) i.onload();

            i.onerror = () => f.classList.remove('show');
        }

        function hidePhoto() { 
            const f = document.getElementById('photo-frame');
            f.classList.remove('show'); 
            // æ³¨æ„ï¼šä¸è¦åœ¨é€™è£¡ç§»é™¤ landscapeï¼Œè®“å®ƒç¸®å›å»æ™‚ä¿æŒåŸæœ¬å½¢ç‹€ï¼Œæ¯”è¼ƒè‡ªç„¶
        }

        function animateMove(s, e) {
            return new Promise(resolve => {
                let startT = performance.now(), dist = getDistance(s.lat, s.lng, e.lat, e.lng);
                // ç¨å¾®ç¸®çŸ­æœ€çŸ­ç§»å‹•æ™‚é–“ï¼Œè®“ç¯€å¥ç·Šæ¹Šä¸€é»
                let dur = Math.min(Math.max(dist*2.5, 1500), 3500); 
                function frame(now) {
                    let p = Math.min((now-startT)/dur, 1);
                    // å¢åŠ å¹³æ»‘éæ¸¡ç®—å¼ (Ease-in-out)
                    let easeP = p < .5 ? 2 * p * p : -1 + (4 - 2 * p) * p;
                    
                    let lat = s.lat + (e.lat-s.lat)*easeP, lng = s.lng + (e.lng-s.lng)*easeP;
                    let curPos = [lat, lng];

                    vehicleMarker.setLatLng(curPos);
                    let temp = [...currentPathCoordinates, curPos]; 
                    pathLine.setLatLngs(temp);
                    map.setView(curPos, map.getZoom(), {animate: false});

                    if(p<1) requestAnimationFrame(frame); else { currentPathCoordinates.push([e.lat,e.lng]); pathLine.setLatLngs(currentPathCoordinates); resolve(); }
                }
                requestAnimationFrame(frame);
            });
        }
        
        function addLocationMarker(p) { L.marker([p.lat, p.lng], {icon: L.divIcon({className:'custom-marker', html:`<div class="custom-label-container"><div class="custom-label">${p.country} ${p.city}</div></div>`, iconSize:[100,40], iconAnchor:[50,20]})}).addTo(map); addDot(p); }
        function addDot(p) { L.circleMarker([p.lat, p.lng], {radius:5, color:'#333', fillColor:'#e63946', fillOpacity:1, weight:1}).addTo(map); }
        function getDistance(lat1,lon1,lat2,lon2) { var R=6371, dLat=deg2rad(lat2-lat1), dLon=deg2rad(lon2-lon1), a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(deg2rad(lat1))*Math.cos(deg2rad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2); return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); }
        function deg2rad(d) { return d*(Math.PI/180); }        function updateStatus(t) { document.getElementById('status-bar').innerText = t; }
        
        function wait(ms) { 
            return new Promise(resolve => {
                const startTime = Date.now();
                
                function checkPause() {
                    if (isPaused) {
                        pauseResolve = () => {
                            const elapsed = Date.now() - startTime;
                            const remaining = ms - elapsed;
                            if (remaining <= 0) {
                                resolve();
                            } else {
                                setTimeout(resolve, remaining);
                            }
                        };
                        return;
                    }
                    
                    const elapsed = Date.now() - startTime;
                    if (elapsed >= ms) {
                        resolve();
                    } else {
                        setTimeout(checkPause, 100);
                    }
                }
                
                checkPause();
            });
        }
          // éŸ³æ¨‚æ§åˆ¶åŠŸèƒ½
        function toggleMusic() {
            const music = document.getElementById('background-music');
            const button = document.getElementById('music-control');
            
            if (music.paused) {
                music.play().then(() => {
                    button.innerHTML = 'ğŸµ';
                    button.title = 'æš«åœéŸ³æ¨‚';
                }).catch(error => {
                    console.log('éŸ³æ¨‚æ’­æ”¾å¤±æ•—:', error);
                });
            } else {
                music.pause();
                button.innerHTML = 'ğŸ”‡';
                button.title = 'æ’­æ”¾éŸ³æ¨‚';
            }
        }
        
        // æš«åœæ§åˆ¶åŠŸèƒ½
        function togglePause() {
            const button = document.getElementById('pause-control');
            const music = document.getElementById('background-music');
            
            if (isPaused) {
                // ç¹¼çºŒ
                isPaused = false;
                button.innerHTML = 'â¸ï¸';
                button.title = 'æš«åœ';
                if (pauseResolve) {
                    pauseResolve();
                    pauseResolve = null;
                }
                // å¦‚æœéŸ³æ¨‚æ­£åœ¨æ’­æ”¾ï¼Œç¢ºä¿å®ƒç¹¼çºŒæ’­æ”¾
                if (!music.paused) {
                    music.play().catch(console.log);
                }
            } else {
                // æš«åœ
                isPaused = true;
                button.innerHTML = 'â–¶ï¸';
                button.title = 'ç¹¼çºŒ';
            }
        }
    </script>
</body>
</html>